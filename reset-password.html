<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Reset Kata Laluan – KB‑JPS</title>
  <link rel="icon" type="image/png" href="assets/logo-jps.png">
  <link rel="stylesheet" href="css/style.css"/>
  <link rel="stylesheet" href="css/theme.css"/>
  <script src="js/utils.js"></script>
  
</head>
<body class="neon-bg">
<div id="kbjpsHeader"></div>
<div class="page">

<div class="card glass">
  <img src="assets/logo-jps.png" class="logo" alt="Logo JPS"/>
  <h2 class="neon-text-sm">Reset Kata Laluan</h2>

  <div class="card">
    <h3 class="neon-text-sm">1) Minta Token Reset</h3>
    <input class="input" type="email" id="reqEmail" placeholder="Email" required/>
    <select class="input" id="method">
      <option value="EMAIL">Email</option>
      <option value="WHATSAPP">WhatsApp</option>
    </select>
    <button class="btn-primary" id="btnReq" style="width:100%;">Jana Token</button>
    <div id="tokenBox" class="status" style="display:none;"></div>
  </div>

  <div class="card">
    <h3 class="neon-text-sm">2) Tukar Kata Laluan</h3>
    <input class="input" type="email" id="confEmail" placeholder="Email" required/>
    <input class="input" id="token" placeholder="Masukkan Token" required/>
    <input class="input" type="password" id="newPass" placeholder="Kata laluan baru (plaintext)" required/>
    <button class="btn-primary" id="btnConf" style="width:100%;">Sahkan & Tukar</button>
    <div id="status" class="status" style="display:none;"></div>
  </div>

  <button class="btn-secondary" style="width:100%;" onclick="location.href='index.html'">← Kembali Log Masuk</button>
</div>

</div>
<div id="kbjpsFooter"></div>
<script>
(async () => {
  try { await KBJPS.ensureSeed(); } catch(e) {}
  const user = KBJPS.auth.getLoggedInUser();
  
  await KBJPS.renderHeader({ title: "Reset Password", backHref: "menu.html", showBack: false, showLogout: false });
  KBJPS.renderFooter();
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tokenBox = document.getElementById("tokenBox");
  const st = document.getElementById("status");
  const showToken = (msg, type) => { tokenBox.style.display="block"; KBJPS.setStatus(tokenBox, msg, type); };
  const show = (msg, type) => { st.style.display="block"; KBJPS.setStatus(st, msg, type); };

  document.getElementById("btnReq").addEventListener("click", async () => {
    showToken("Memproses...", "info");
    try{
      const email = document.getElementById("reqEmail").value;
      const method = document.getElementById("method").value;
      const r = await KBJPS.reset.requestReset(email, method);
      showToken("TOKEN RESET (papar dalam UI): " + r.token + " | Tamat: 30 minit", "ok");
      document.getElementById("confEmail").value = email;
      document.getElementById("token").value = r.token;
    } catch(err){
      showToken("Gagal: " + (err.message || err), "error");
    }
  });

  document.getElementById("btnConf").addEventListener("click", async () => {
    show("Memproses...", "info");
    try{
      await KBJPS.reset.confirmReset(
        document.getElementById("confEmail").value,
        document.getElementById("token").value,
        document.getElementById("newPass").value
      );
      show("Berjaya! Kata laluan ditukar. Sila login semula.", "ok");
    } catch(err){
      show("Gagal: " + (err.message || err), "error");
    }
  });
});
</script>

</body>
</html>
